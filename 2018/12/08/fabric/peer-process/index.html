

<!DOCTYPE html>
<html lang="zh">
<!--begin head-->

<head>
    <meta charset="utf-8">
<!--begin title-->

<title>
    
    Hyperledge fabric peer 流程分析 |
    
    Blog of Scheme</title>
<!--end title-->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<!--begin mete-->

<meta name="description" content="Blog of Scheme, misc things of computer"/>

<meta name="author" content="Scheme J"/>

<!--end mete-->
<!--begin keywords-->
<meta name="keywords" content="Android,adeb,blockchain,cluster,composer,fabric,geth,hyperledge,hyperledger,linux,proxmox,start,test"/>
<!--end keywords-->
<!--begin rss-->

<link rel="alternate" href="/atom.xml" title="Blog of Scheme" type="application/atom+xml">

<!--end rss-->
<!--begin favicon-->

<link rel="icon" href="/favicon.ico">

<!--end favicon-->
<!--begin style-->

<!-- stylesheets list from config.yml -->

<link rel="stylesheet" href="/css/hannah.css">


<!--end style-->
<meta name="generator" content="Hexo 4.2.1"></head>
<!--end head-->
<!--begin body-->

<body class="container-fluid">

    <!--begin menu-->
    <div class="hannah-menu">
    <i class="fh fh-ravelry fa-2x btn fixed-menu animated bounce" id="btn_menu" aria-hidden="true"></i>
    <div class="menu-outer container-fluid hide animated" id="div_menu">
        <div class="row" style="margin-bottom: 5px;">
            
            <div class="col-md-offset-2 col-md-3 col-xs-4 text-center left-social">
                
                <a target="_blank" href="https://github.com/marryton007" title="GitHub"><i class="fh fh-github"></i></a>
                
                <style>
                    .left-social {
                        height: 132px;
                        line-height: 132px;
                        font-size: 66px;
                    }

                    .left-social * {
                        color: #f1ce8e;
                    }

                    @media (max-width: 767px) {
                        .left-social {
                            line-height: 132px;
                            font-size: 33px;
                        }
                    }
                </style>
            </div>
            <!--begin handImg-->
            <div class="col-md-2 col-xs-4 text-center">
                
                <img src="/img/logo.png" alt="Head Image" class="img-circle">
                
            </div>
            <!--end handImg-->
            <div class="col-md-3 col-xs-4 text-center right-social">
                
                <style>
                    .right-social {
                        height: 132px;
                        line-height: 132px;
                        font-size: 66px;
                    }

                    @media (max-width: 767px) {
                        .right-social {
                            line-height: 132px;
                            font-size: 33px;
                        }
                    }

                    .right-social * {
                        color: #f1ce8e;
                    }
                </style>
            </div>
        </div>
        <div class="row">
            <div class="menu-content col-md-8 col-md-push-2 col-xs-12 ">
                <dl class="menu-content-item">
                    <dt class="menu-content-title">
                        <i class="fh fh-bars" aria-hidden="true"></i> Menu
                    </dt>
                    <dd class="menu-content-content">
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/" class="btn btn-block">
                                
                                <i class="fh fh-ravelry"></i>
                                Home
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/categories" class="btn btn-block">
                                
                                <i class="fh fh-cubes"></i>
                                Category
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/tags" class="btn btn-block">
                                
                                <i class="fh fh-tags"></i>
                                Tag
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/archives" class="btn btn-block">
                                
                                <i class="fh fh-archive"></i>
                                Archives
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/about" class="btn btn-block">
                                
                                <i class="fh fh-about"></i>
                                About
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/doc" class="btn btn-block">
                                
                                <i class="fh fh-document"></i>
                                Doc
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/plug" class="btn btn-block">
                                
                                <i class="fh fh-plug"></i>
                                Plug
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/sitemap" class="btn btn-block">
                                
                                <i class="fh fh-sitemap"></i>
                                SiteMap
                            </a>
                        </div>
                        
                        <div class="col-md-4 col-xs-6 col-sm-4 text-center animated tada">
                            <a href="/atom.xml" class="btn btn-block">
                                <i class="fh fh-rss" aria-hidden="true"></i> RSS
                            </a>
                        </div>
                    </dd>
                </dl>
            </div>
        </div>
        <div class="row">
            <div class="menu-content col-md-8 col-md-offset-2 col-xs-12 ">
                <dl class="col-md-6 col-xs-6 menu-content-item">
                    <dt class="menu-content-title">
                        <i class="fh fh-cubes" aria-hidden="true"></i> Category
                    </dt>
                    <dd class="menu-content-content animated zoomIn">
                        <ul class="menu-cate-list"><li class="menu-cate-list-item"><a class="menu-cate-list-link" href="/categories/blockchain/"><i class="fh fh-cube" aria-hidden="true"></i> blockchain</a><span class="menu-cate-list-count">7</span></li><li class="menu-cate-list-item"><a class="menu-cate-list-link" href="/categories/cluster/"><i class="fh fh-cube" aria-hidden="true"></i> cluster</a><span class="menu-cate-list-count">1</span></li><li class="menu-cate-list-item"><a class="menu-cate-list-link" href="/categories/code/"><i class="fh fh-cube" aria-hidden="true"></i> code</a><span class="menu-cate-list-count">1</span></li><li class="menu-cate-list-item"><a class="menu-cate-list-link" href="/categories/embedded/"><i class="fh fh-cube" aria-hidden="true"></i> embedded</a><span class="menu-cate-list-count">1</span></li><li class="menu-cate-list-item"><a class="menu-cate-list-link" href="/categories/web%E5%89%8D%E7%AB%AF/"><i class="fh fh-cube" aria-hidden="true"></i> web前端</a><span class="menu-cate-list-count">1</span></li></ul>
                    </dd>
                </dl>
                <dl class="col-md-6 col-xs-6 menu-content-item">
                    <dt class="menu-content-title">
                        <i class="fh fh-tag" aria-hidden="true"></i> Tags
                    </dt>
                    <dd class="menu-content-content animated zoomIn">
                        <ul class="menu-tag-list" itemprop="keywords"><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/Android/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> Android</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/adeb/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> adeb</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/blockchain/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> blockchain</a><span class="menu-tag-list-count">9</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/cluster/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> cluster</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/composer/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> composer</a><span class="menu-tag-list-count">3</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/fabric/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> fabric</a><span class="menu-tag-list-count">2</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/geth/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> geth</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/hyperledge/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> hyperledge</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/hyperledger/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> hyperledger</a><span class="menu-tag-list-count">5</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/linux/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> linux</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/proxmox/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> proxmox</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/start/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> start</a><span class="menu-tag-list-count">1</span></li><li class="menu-tag-list-item"><a class="menu-tag-list-link" href="/tags/test/" rel="tag"><i class="fh fh-tag" aria-hidden="true"></i> test</a><span class="menu-tag-list-count">1</span></li></ul>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>
    <!--end menu-->

    <div class="row hannah-body">
        <div class="col-md-8 col-md-push-2 col-xs-12">
            <!--begin breadcrumb-->
            <div class="bread-crumb">
    <ul class="bread-crumb-menu animated rubberBand">
        <li><a href="/"><i class="fh fh-ravelry" aria-hidden="true"></i> Home</a></li>
        
        <li><a href="/categories/code/"><i class="fh fh-cube" aria-hidden="true"></i> code</a>
        </li>
        
        <li>
            
            <i class="fh fh-newspaper-o" aria-hidden="true"></i>
            
            Hyperledge fabric peer 流程分析
        </li>
        
    </ul>
    <div class="bread-crumb-search">
        <div class="search">
    <i class="fh fh-search icon-search"></i>
    <input placeholder="Search ..." onkeyup="searchFunc(this,event,'/search.xml')"
           class="input-search animated fadeInRight"/>
    <div class="search-result animated fadeInRight">
        <a class="animated tada col-lg-12 search-result-item result-link" href="/2022/04/29/embedded/adeb/">Android环境中bcc/bpftrace环境搭建</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2020/06/08/test/">test</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2018/12/08/fabric/peer-process/">Hyperledge fabric peer 流程分析</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2018/11/08/proxmox/proxmox-setup/">proxmox 集群搭建</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2018/04/22/blockchain/composer-k8s-fabric-deploy/">使用composer+k8s部署hyperledger fabric 1.1.0</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2018/04/13/blockchain/geth-json-rpc/">以太坊节点geth json rpc使用指南</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2017/09/28/blockchain/kafka-cluster/">搭建Kafka集群</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2017/09/04/blockchain/hyperledger-composer-learn/">hyperledger composer 实战</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2017/08/24/blockchain/fabric-transaction-flow/">hyperledger fabric交易流程</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2017/08/23/blockchain/first-fabric-application/">基于hyperledger fabric网络的第一个应用</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2017/08/22/blockchain/build-first-fabric-network/">使用hyperledger fabric构建你的第一个区块链网络</a><a class="animated tada col-lg-12 search-result-item result-link" href="/2017/08/18/blockchain/blockchain-describe/">白话区块链</a>
    </div>
</div>
    </div>
</div>
            <!--end breadcrumb-->
            <!--begin body-->
            <article class="post animated rollIn">
    <h1 class="post-title">Hyperledge fabric peer 流程分析</h1>
    <div class="post-subtitle">
        
        <time datetime="2018-12-08T06:17:39.000Z" class="item">
            <i class="fh fh-calendar" aria-hidden="true"></i>&nbsp;&nbsp;2018-12-08
        </time>
        
        
        <span class="item">
      <i class="fh fh-cubes" aria-hidden="true"></i>&nbsp;
            
            <a class="label label-primary tags" href="/categories/code/">
           <i class="fh fh-cube" aria-hidden="true"></i>&nbsp;code
        </a>
            
        </span>
        
        
        <span class="item">
        <i class="fh fh-tags" aria-hidden="true"></i>&nbsp;
            
            <a class="label label-info tags" href="/tags/blockchain/">
            <i class="fh fh-tag" aria-hidden="true"></i>&nbsp;blockchain
            </a>
            
            <a class="label label-info tags" href="/tags/fabric/">
            <i class="fh fh-tag" aria-hidden="true"></i>&nbsp;fabric
            </a>
            
            <a class="label label-info tags" href="/tags/hyperledge/">
            <i class="fh fh-tag" aria-hidden="true"></i>&nbsp;hyperledge
            </a>
            
        </span>
        
    </div>
    
    <ol>
<li><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近花了大概 2 个星期左右阅读了 fabric-1.2.1 中与 peer 相关的源码，着重阅读了与 Chaincode(链码)交互相关的逻辑，因为之前并没有找到一些特别好的参考资料，在这里还是耽误了些时间，不过还好，虽是走了些弯路，但还算是走出来了。</p>
</li>
<li><h2 id="关键库"><a href="#关键库" class="headerlink" title="关键库"></a>关键库</h2><p>在<a href="https://read.douban.com/ebook/57504608/" target="_blank" rel="noopener">Hyperledger Fabric 源代码分析与深入解读</a>这本书中，第 3 章介绍了相关的库，如日志、配置文件、<a href="https://grpc.io/" target="_blank" rel="noopener">grpc</a>，Error，不过这本书是针对的 fabric1.0 版的代码，我看的源代码是 1.2.1 版，所以有些地方对不上，只能作为一个参考；下面列出的库还是很重要的：</p>
<ul>
<li>Logging，日志库，可以按级别打印消息，可用来调试</li>
<li><a href="https://github.com/spf13/viper" target="_blank" rel="noopener">viper</a>，配置文件读取，源码里相当多的地方要读取配置文件中的内容，所以你要知道<a href="https://github.com/spf13/viper" target="_blank" rel="noopener">viper</a>的工作原理，如去哪里找配置文件，及如何查找相关的配置项</li>
<li><a href="https://grpc.io/" target="_blank" rel="noopener">grpc</a>，fabric 是个分布式系统，各个组件可能并没有在一台主机上，那各组件之间如何通信，这里就用到<a href="https://grpc.io/" target="_blank" rel="noopener">grpc</a>框架了，强烈建议你先去看<a href="https://grpc.io/" target="_blank" rel="noopener">grpc</a>的官方文档，学习写个 Demo，再回头来看代码。</li>
<li><a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">cobra</a>, 用 go 实现的命令行开发库，支持多级子命令，如 peer node start，cobra 的用法也比较好理解，看一下官方文档就好了。</li>
</ul>
</li>
<li><h2 id="相关工具、方法"><a href="#相关工具、方法" class="headerlink" title="相关工具、方法"></a>相关工具、方法</h2><p>工欲善其事，必先利其器，一个好的工具可以让你少走很多弯路，</p>
<ul>
<li>源码阅读工具<br>推荐使用 JetBrains Goland，它是专来 golang 环境设置的，操作起来比较简单，直观</li>
<li>调试环境<br>推荐使用 docker+remote debug 方式，在 docker 容器中安装 dlv 远程调试工具，这种方式并比较简单，只需要对原来的容器稍做定制，就可以通过命令行或 IDE 方式连接到 docker, 这种方式支持大多数的 IDE 环境，如 Visual code 和 goland,请参考这篇文章<a href="https://blog.jetbrains.com/go/2018/04/30/debugging-containerized-go-applications/" target="_blank" rel="noopener">Debugging containerized Go applications</a></li>
</ul>
</li>
<li><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ul>
<li><p>总流程<br>peer/main.go –&gt; node/start.go 对应 peer node start 命令， peer 模块从 start.go 中的 serv 函数开始<br><img src="/img/fabric/peer-start.png" alt="peer_start"></p>
<p>可以看出 peer node start 就是启动一系列的 grpc 服务，供其他模块调用，下面具体看一下 Chaincode support 服务</p>
</li>
<li><p>Chaincode-support<br>该服务主要用来响应 Chaincode 的相关调用。<br><img src="/img/fabric/chaincode.png" alt="Chaincode_handle"></p>
</li>
<li><p>Chaincode docker<br>大家已经知道 fabric 的 Chaincode 是通过 Docker 运行的，那其中到底是个什么逻辑呢？ 我们来跟踪一下。前面已经知道 Chaincode-support 服务启动后，从 Created 状态一直到 Ready 状态，这时就可以开始处理链码相关调用了，如下面这样</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">handleMessageReadyState</span><span class="params">(msg *pb.ChaincodeMessage)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   <span class="keyword">switch</span> msg.Type &#123;</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_COMPLETED, pb.ChaincodeMessage_ERROR:</span><br><span class="line">       h.Notify(msg)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_PUT_STATE:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandlePutState)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_DEL_STATE:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleDelState)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_INVOKE_CHAINCODE:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleInvokeChaincode)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_GET_STATE:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleGetState)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_GET_STATE_BY_RANGE:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleGetStateByRange)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_GET_QUERY_RESULT:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleGetQueryResult)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_GET_HISTORY_FOR_KEY:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleGetHistoryForKey)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_QUERY_STATE_NEXT:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleQueryStateNext)</span><br><span class="line">   <span class="keyword">case</span> pb.ChaincodeMessage_QUERY_STATE_CLOSE:</span><br><span class="line">       <span class="keyword">go</span> h.HandleTransaction(msg, h.HandleQueryStateClose)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">"[%s] Fabric side handler cannot handle message (%s) while in ready state"</span>, msg.Txid, msg.Type)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中比较主要的服务 HandleInvokeChaincode，我们来看看</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">HandleInvokeChaincode</span><span class="params">()</span></span>&#123;</span><br><span class="line">   ...</span><br><span class="line">   ctxt = context.WithValue(ctxt, TXSimulatorKey, txsim)</span><br><span class="line">   ctxt = context.WithValue(ctxt, HistoryQueryExecutorKey, historyQueryExecutor)</span><br><span class="line">   ...</span><br><span class="line">   responseMessage, err := h.Invoker.Invoke(ctxt, cccid, cciSpec)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> cctyp pb.ChaincodeMessage_Type</span><br><span class="line">   <span class="keyword">switch</span> spec.(<span class="keyword">type</span>) &#123;</span><br><span class="line">   <span class="keyword">case</span> *pb.ChaincodeDeploymentSpec:</span><br><span class="line">       cctyp = pb.ChaincodeMessage_INIT</span><br><span class="line">   <span class="keyword">case</span> *pb.ChaincodeInvocationSpec:</span><br><span class="line">       cctyp = pb.ChaincodeMessage_TRANSACTION</span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"a deployment or invocation spec is required"</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 这里非常重要，这里是要启动链码，如果是普通合约，则使用Docker容器来启动</span></span><br><span class="line">   err := cs.Launch(ctxt, cccid, spec)</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">// 开始执行链码中对应的函数</span></span><br><span class="line">   <span class="keyword">return</span> cs.execute(ctxt, cccid, ccMsg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪 Launch</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Launch</span><span class="params">()</span></span>&#123;</span><br><span class="line">   ctx = context.WithValue(ctx, ccintf.GetCCHandlerKey(), cs)</span><br><span class="line">   <span class="keyword">return</span> cs.Launcher.Launch(ctx, cccid, spec)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到 RuntimeLauncher.Launch</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RuntimeLauncher)</span> <span class="title">Launch</span><span class="params">()</span></span>&#123;</span><br><span class="line">    err := r.start(ctx, cccid, cds)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到 RuntimeLauncher.start</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RuntimeLauncher)</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">    err := r.Runtime.Start(ctx, cccid, cds)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到 ContainerRuntime.start</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ContainerRuntime)</span> <span class="title">Start</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> err := c.Processor.Process(ctxt, vmtype, scr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> errors.WithMessage(err, <span class="string">"error starting container"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续到 VMController.Process</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(vmc *VMController)</span> <span class="title">Process</span><span class="params">(ctxt context.Context, vmtype <span class="keyword">string</span>, req VMCReq)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   v := vmc.newVM(vmtype)</span><br><span class="line">   ccid := req.GetCCID()</span><br><span class="line">   id := ccid.GetName()</span><br><span class="line"></span><br><span class="line">   vmc.lockContainer(id)</span><br><span class="line">   <span class="keyword">defer</span> vmc.unlockContainer(id)</span><br><span class="line">   <span class="comment">// 根据vmtype执行相应的do， 如果是一般使用，使用dockerVM执行，如果是系统合约，则使用InporcVM执行</span></span><br><span class="line">   <span class="keyword">return</span> req.Do(ctxt, v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动 docker 容器，如果没有相关镜像，还要 build 一个镜像出来，再使用镜像启动容器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(vm *DockerVM)</span> <span class="title">Start</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 创建Docker容器，该容器中已经包含了要调用的链码程序</span></span><br><span class="line">    err = vm.createContainer(ctxt, client, imageName, containerName, args, env, attachStdout)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// 这里如果没有相关的镜像，这里还要负责编译一个镜像出来</span></span><br><span class="line">       reader, err1 := builder.Build()</span><br><span class="line">       <span class="keyword">if</span> err1 != <span class="literal">nil</span> &#123;</span><br><span class="line">           dockerLogger.Errorf(<span class="string">"Error creating image builder for image &lt;%s&gt; (container id &lt;%s&gt;), "</span>+</span><br><span class="line">               <span class="string">"because of &lt;%s&gt;"</span>, imageName, containerName, err1)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> err1 = vm.deployImage(client, ccid, args, env, reader); err1 != <span class="literal">nil</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> err1</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       dockerLogger.Debug(<span class="string">"start-recreated image successfully"</span>)</span><br><span class="line">       <span class="keyword">if</span> err1 = vm.createContainer(ctxt, client, imageName, containerName, args, env, attachStdout); err1 != <span class="literal">nil</span> &#123;</span><br><span class="line">           dockerLogger.Errorf(<span class="string">"start-could not recreate container post recreate image: %s"</span>, err1)</span><br><span class="line">           <span class="keyword">return</span> err1</span><br><span class="line">       &#125;</span><br><span class="line">    <span class="comment">// 启动Docker容器</span></span><br><span class="line">    err = client.StartContainer(containerName, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>回到 ChaincodeSupport.Invoke()</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> cs.execute(ctxt, cccid, ccMsg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 cs.execute 函数中，ChaincodeSupport 向 docker 容器发送消息，请求执行链码对应的功能，容器中的链码收到消息后，处理请求，并返回结果。主流程并不是太复杂，下图可以总结：</p>
<p><img src="/img/fabric/chaincode-ps.png" alt="invoke_call"></p>
</li>
<li><p>docker build<br>现在把目光放到如何把链码编译成镜像，并启动容器上来，还记得前面的那段吧？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Builder <span class="keyword">interface</span> &#123;</span><br><span class="line">   Build() (io.Reader, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JetBrains Goland 这个工具确实很人性化，接口在哪里实现的，都会直接列出来</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Build a tar stream based on the CDS</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *PlatformBuilder)</span> <span class="title">Build</span><span class="params">()</span> <span class="params">(io.Reader, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">return</span> platforms.GenerateDockerBuild(b.DeploymentSpec)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenerateDockerBuild</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">   inputFiles := <span class="built_in">make</span>(InputFiles)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">   <span class="comment">// Determine our platform driver from the spec</span></span><br><span class="line">   <span class="comment">// ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">   platform, err := _Find(cds.ChaincodeSpec.Type)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Failed to determine platform type: %s"</span>, err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">   <span class="comment">// Generate the Dockerfile specific to our context</span></span><br><span class="line">   <span class="comment">// ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">   dockerFile, err := _generateDockerfile(platform, cds)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Failed to generate a Dockerfile: %s"</span>, err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   inputFiles[<span class="string">"Dockerfile"</span>] = dockerFile</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">   <span class="comment">// Finally, launch an asynchronous process to stream all of the above into a docker build context</span></span><br><span class="line">   <span class="comment">// ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">   input, output := io.Pipe()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       gw := gzip.NewWriter(output)</span><br><span class="line">       tw := tar.NewWriter(gw)</span><br><span class="line">       err := _generateDockerBuild(platform, cds, inputFiles, tw)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           logger.Error(err)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       tw.Close()</span><br><span class="line">       gw.Close()</span><br><span class="line">       output.CloseWithError(err)</span><br><span class="line">   &#125;()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> input, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数干了 3 件事</p>
<ul>
<li>判断是哪种语言编写的链码<br>fabric-1.2.1 已经开始支持 4 种语言的链码了，golang/java/car/javascrit，不同的语言环境，需要不同的编译工具和依赖环境，最终将链码打包成一个可执行的程序，这里以 golang 语言为例分析。</li>
<li>生成一个 Dockerfile 文件，熟悉 Docker 的同学看到这里，可以已经有点眉目了。</li>
<li>启动一个 ccenv 容器编译链码，并生成一个新的镜像文件，专用于执行链码</li>
</ul>
<p>我们来看一下第 2 步，生成的 Dockerfile 文件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(goPlatform *Platform)</span> <span class="title">GenerateDockerfile</span><span class="params">(cds *pb.ChaincodeDeploymentSpec)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> buf []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">   buf = <span class="built_in">append</span>(buf, <span class="string">"FROM "</span>+cutil.GetDockerfileFromConfig(<span class="string">"chaincode.golang.runtime"</span>))</span><br><span class="line">   buf = <span class="built_in">append</span>(buf, <span class="string">"ADD binpackage.tar /usr/local/bin"</span>)</span><br><span class="line"></span><br><span class="line">   dockerFileContents := strings.Join(buf, <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> dockerFileContents, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>非常典型的 Dockfile 文件，进入在一个正在运行 peer 的容器，查看/etc/hyperledger/img/fabric/core.yml 文件，最终出来的大概是如下这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; FROM $(BASE_DOCKER_NS)&#x2F;fabric-baseos:$(ARCH)-$(BASE_VERSION)</span><br><span class="line">FROM hyperledger&#x2F;fabric-baseos:amd64-0.4.13</span><br><span class="line">ADD binpackage.tar &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure>

<p>这个 Dockerfile 要求一个 binpackage.tar 文件，这个文件在哪呢？ 接着往下看</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(goPlatform *Platform)</span> <span class="title">GenerateDockerBuild</span><span class="params">(cds *pb.ChaincodeDeploymentSpec, tw *tar.Writer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   spec := cds.ChaincodeSpec</span><br><span class="line">   ...</span><br><span class="line">   codepackage := bytes.NewReader(cds.CodePackage)</span><br><span class="line">   binpackage := bytes.NewBuffer(<span class="literal">nil</span>)</span><br><span class="line">   err = util.DockerBuild(util.DockerBuildOptions&#123;</span><br><span class="line">       Cmd:          fmt.Sprintf(<span class="string">"GOPATH=/chaincode/input:$GOPATH go build -tags \"%s\" %s -o /chaincode/output/chaincode %s"</span>, gotags, ldflagsOpt, pkgname),</span><br><span class="line">       InputStream:  codepackage,</span><br><span class="line">       OutputStream: binpackage,</span><br><span class="line">   &#125;)</span><br><span class="line">   ...</span><br><span class="line">   <span class="keyword">return</span> cutil.WriteBytesToPackage(<span class="string">"binpackage.tar"</span>, binpackage.Bytes(), tw)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到 Cmd 那行，看起来是不是用 go build 在编译 go 代码？<br>其中 util.DockerBuild()如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DockerBuild</span><span class="params">(opts DockerBuildOptions)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   client, err := cutil.NewDockerClient()</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">// 这里镜像文件是 hyperledger/fabric-ccenv:latest</span></span><br><span class="line">   <span class="keyword">if</span> opts.Image == <span class="string">""</span> &#123;</span><br><span class="line">       opts.Image = cutil.GetDockerfileFromConfig(<span class="string">"chaincode.builder"</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//-----------------------------------------------------------------------------------</span></span><br><span class="line">   <span class="comment">// 确认镜像是否存在，如果没有，则先使用docker pull下载镜像文件</span></span><br><span class="line">   <span class="comment">//-----------------------------------------------------------------------------------</span></span><br><span class="line">   _, err = client.InspectImage(opts.Image)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       logger.Debugf(<span class="string">"Image %s does not exist locally, attempt pull"</span>, opts.Image)</span><br><span class="line"></span><br><span class="line">       err = client.PullImage(docker.PullImageOptions&#123;Repository: opts.Image&#125;, docker.AuthConfiguration&#123;&#125;)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> fmt.Errorf(<span class="string">"Failed to pull %s: %s"</span>, opts.Image, err)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//-----------------------------------------------------------------------------------</span></span><br><span class="line">   <span class="comment">// Upload our input stream</span></span><br><span class="line">   <span class="comment">//-----------------------------------------------------------------------------------</span></span><br><span class="line">   err = client.UploadToContainer(container.ID, docker.UploadToContainerOptions&#123;</span><br><span class="line">       Path:        <span class="string">"/chaincode/input"</span>,</span><br><span class="line">       InputStream: opts.InputStream,</span><br><span class="line">   &#125;)</span><br><span class="line">   ...</span><br><span class="line">   err = client.StartContainer(container.ID, <span class="literal">nil</span>)</span><br><span class="line">   ...</span><br><span class="line">   retval, err := client.WaitContainer(container.ID)</span><br><span class="line">   ...</span><br><span class="line">   err = client.DownloadFromContainer(container.ID, docker.DownloadFromContainerOptions&#123;</span><br><span class="line">       Path:         <span class="string">"/chaincode/output/."</span>,</span><br><span class="line">       OutputStream: opts.OutputStream,</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里大概意思是使用 hyperledger/ccenv 这个镜像来编译链码，被编译出的可执行文件为/chaincode/output/chaincode，并将 docker 里的/chaincode/output/这个目录的内容打包，最终生成前面所需要的 binpackage.tar，最终再根据 Dockerfile 生成了我们需要的镜像文件。到这里为止，链码镜像的生成就算是结束了，不过还有个小的问题:</p>
<ul>
<li><p>链码编译的时候的依赖是怎么解决的<br>这里我们看一看 ccenv 这个镜像是怎么生成的(images/ccenv/Dockerfile.in)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> _BASE_NS_/fabric-baseimage:_BASE_TAG_</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> payload/chaintool payload/protoc-gen-go /usr/<span class="built_in">local</span>/bin/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> payload/goshim.tar.bz2 <span class="variable">$GOPATH</span>/src/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /chaincode/input /chaincode/output</span></span><br></pre></td></tr></table></figure>

<p>其中有一行将 goshim.tar.bz2 拷贝到$GOPATH/src目录，$GOPATH/src 目录下一般放的都 go 的源码，go 程序在编译的时候会在这个目录下搜索相关的库，那这里 goshim.tar.bz2 是又是怎么来的？</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GOSHIM_DEPS = <span class="variable">$(<span class="built_in">shell</span> ./scripts/goListFiles.sh <span class="variable">$(PKGNAME)</span>/core/chaincode/shim)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2: <span class="variable">$(GOSHIM_DEPS)</span></span><br><span class="line">    @echo <span class="string">"Creating <span class="variable">$@</span>"</span></span><br><span class="line">    @tar -jhc -C <span class="variable">$(GOPATH)</span>/src <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(GOPATH)</span>/src/%,%,<span class="variable">$(GOSHIM_DEPS)</span>)</span> &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/image/ccenv/payload:      <span class="variable">$(BUILD_DIR)</span>/docker/gotools/bin/protoc-gen-go \</span><br><span class="line">        <span class="variable">$(BUILD_DIR)</span>/bin/chaintool \</span><br><span class="line">        <span class="variable">$(BUILD_DIR)</span>/goshim.tar.bz2</span><br></pre></td></tr></table></figure>

<p>我们看 goshim.tar.bz2 这个压缩文件，是通过一个脚本得到 GOSHIM_DEPS，再把 GOSHIM_DEPS 打成 tar.bz2 包</p>
<p><img src="/img/fabric/chaincode-build.png" alt="docker-build"></p>
</li>
</ul>
</li>
<li><p>shim<br>在没看代码之间，一直不理解 shim(垫片)是个啥？大家在编写 Chaincode 的时候是不是总有这么一段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// Create a new Smart Contract</span></span><br><span class="line">   err := shim.Start(<span class="built_in">new</span>(SmartContract))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       fmt.Printf(<span class="string">"Error creating new Smart Contract: %s"</span>, err)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一段其实是在 Docker 容器里执行的，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chaincodes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(cc Chaincode)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   <span class="comment">//mock stream not set up ... get real stream</span></span><br><span class="line">   <span class="keyword">if</span> streamGetter == <span class="literal">nil</span> &#123;</span><br><span class="line">       streamGetter = userChaincodeStreamGetter</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   stream, err := streamGetter(chaincodename)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   err = chatWithPeer(chaincodename, stream, cc)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>合约里调用 shim.Start()，就对应到了下面的这面代码，这里主要的用途是建立一个对话的通道，将来 peer 和 docker 的消息交换都是这个通道进行。</p>
</li>
</ul>
</li>
<li><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>内容有点多，其实有 2 大块内容，</p>
<ul>
<li>SDK/peer/docker 是如何互相配合的</li>
<li>链码是如何被编译成镜像，运行起来的</li>
<li>shim(垫片)</li>
</ul>
</li>
<li><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://read.douban.com/ebook/57504608/" target="_blank" rel="noopener">Hyperledger Fabric 源代码分析与深入解读</a></li>
<li><a href="https://hk.saowen.com/a/2dbad2b467f6331a5ad8e73d46500aa5efa9b848f30b5dfdcca0b475bbddb860" target="_blank" rel="noopener">Hyperledger Chaincode 啟動過程-掃文資訊</a></li>
<li><a href="https://grpc.io/" target="_blank" rel="noopener">grpc</a></li>
<li><a href="https://github.com/spf13/viper" target="_blank" rel="noopener">viper</a></li>
<li><a href="https://blog.jetbrains.com/go/2018/04/30/debugging-containerized-go-applications/" target="_blank" rel="noopener">Debugging containerized Go applications</a></li>
<li><a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">cobra</a></li>
</ul>
</li>
</ol>

</article>
<ol class="animated rollIn hannah-toc"><li class="animated rollIn hannah-toc-item animated rollIn hannah-toc-level-2"><a class="animated rollIn hannah-toc-link" href="#背景"><span class="animated rollIn hannah-toc-text">背景</span></a></li><li class="animated rollIn hannah-toc-item animated rollIn hannah-toc-level-2"><a class="animated rollIn hannah-toc-link" href="#关键库"><span class="animated rollIn hannah-toc-text">关键库</span></a></li><li class="animated rollIn hannah-toc-item animated rollIn hannah-toc-level-2"><a class="animated rollIn hannah-toc-link" href="#相关工具、方法"><span class="animated rollIn hannah-toc-text">相关工具、方法</span></a></li><li class="animated rollIn hannah-toc-item animated rollIn hannah-toc-level-2"><a class="animated rollIn hannah-toc-link" href="#流程"><span class="animated rollIn hannah-toc-text">流程</span></a></li><li class="animated rollIn hannah-toc-item animated rollIn hannah-toc-level-2"><a class="animated rollIn hannah-toc-link" href="#总结"><span class="animated rollIn hannah-toc-text">总结</span></a></li><li class="animated rollIn hannah-toc-item animated rollIn hannah-toc-level-2"><a class="animated rollIn hannah-toc-link" href="#参考资料"><span class="animated rollIn hannah-toc-text">参考资料</span></a></li></ol>
<div class="animated bounceInDown paginations">
    <div class="col-md-8 col-md-push-2 col-xs-12">
        <nav>
            
            <a href="/2020/06/08/test/" class="prev col-md-2 col-xs-4 text-left">&larr; Prev</a>
            
            <span
                class="page-content col-md-8  col-xs-4 text-center">
                
            </span>
            
            <a href="/2018/11/08/proxmox/proxmox-setup/" class="next col-md-2 col-xs-4 text-right">Next &rarr;</a>
            
        </nav>
        <div>
            <div class="col-md-6 col-xs-6 text-left">
                
                test
                
            </div>
            <div class="col-md-6 col-xs-6 text-right">
                
                proxmox 集群搭建
                
            </div>
        </div>
    </div>
</div>

            <!--end body-->
            <!--begin comments-->
            
<div class="comments">
    

    
    
</div>


            <!--end comments-->
        </div>
    </div>

    <!--begin footer-->
    <footer id="footer" class="footer animated fadeInUp hide">
    <p><i class="copy">&copy;</i> 2022 <a href="http://marryton007.github.io">Scheme J</a> All Right Reserved.</p>
    <p>Powered by <a href="http://hexo.io" target="_blank" rel="external nofollow noopener">Hexo</a>. Theme by <a href="https://github.com/objectyan/hexo-theme-hannah" target="_blank" rel="external nofollow noopener">hannah</a></p>
</footer>
    <!--end footer-->

    
    <!-- scripts list from theme config.yml -->
    
    <script src="/js/hannah.js"></script>
    
    
    <!--begin analytics-->
    

    <!--end analytics-->
</body>
<!--end body-->
<!--begin canvas-nest-->
<script>
    var nesturl = "https://unpkg.com/canvas-nest.js/dist/canvas-nest.js";
    var c = document.getElementsByTagName("body")[0] || document.body || document.documentElement;
    var b = document.createElement("script");
    b.setAttribute("type", "text/javascript");
    b.setAttribute("src", nesturl);
    b.setAttribute("color",
        `${ Math.floor(Math.random()*256)},${ Math.floor(Math.random()*256)},${ Math.floor(Math.random()*256)}`);
    b.setAttribute("opacity", Math.random());
    b.setAttribute("count", parseInt((Math.random() * 500) || 99));
    c.appendChild(b)
</script>
<!--end canvas-nest-->

</html>